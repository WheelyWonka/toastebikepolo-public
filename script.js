const API_CONFIG={baseUrl:window.TOASTE_CONFIG?.apiBaseUrl||"https://rest.toastebikepolo.ca/.netlify/functions"};async function wakeUpServer(){try{console.log("🌅 Waking up server...");const e=await fetch(`${API_CONFIG.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});e.ok?console.log("✅ Server is awake and ready!"):console.log("⚠️ Server wake-up response not OK:",e.status)}catch(e){console.log("⚠️ Server wake-up failed (this is normal for free plan):",e.message)}}const productForm=document.getElementById("product-form"),customerForm=document.getElementById("customer-form"),productSection=document.getElementById("product-selection"),contactSection=document.getElementById("contact-form"),reviewSection=document.getElementById("order-review"),confirmationSection=document.getElementById("confirmation"),orderCodeSpan=document.getElementById("order-code"),spokeCountGroup=document.getElementById("spoke-count-group"),wheelSizeGroup=document.getElementById("wheel-size-group"),spokeCountInput=document.getElementById("spoke-count"),wheelSizeInput=document.getElementById("wheel-size"),cartSummary=document.getElementById("cart-summary"),cartItems=document.getElementById("cart-items"),totalPriceSpan=document.getElementById("total-price"),quantityInput=document.getElementById("quantity"),quantityMinusBtn=document.getElementById("quantity-minus"),quantityPlusBtn=document.getElementById("quantity-plus"),addToCartBtn=document.querySelector(".add-to-cart-btn"),reviewContactInfo=document.getElementById("review-contact-info"),reviewOrderItems=document.getElementById("review-order-items"),reviewTotalPrice=document.getElementById("review-total-price");let selectedProducts=[],currentProduct={spokeCount:"",wheelSize:"",quantity:1};const STORAGE_KEYS={CART:"toaste_cart",CONTACT_INFO:"toaste_contact_info",CURRENT_PRODUCT:"toaste_current_product"};function loadCartFromStorage(){try{const e=localStorage.getItem(STORAGE_KEYS.CART);e&&(selectedProducts=JSON.parse(e),updateCartDisplay());const t=localStorage.getItem(STORAGE_KEYS.CURRENT_PRODUCT);if(t){const e=JSON.parse(t);if(currentProduct={...currentProduct,...e},currentProduct.spokeCount){document.querySelector(`[data-value="${currentProduct.spokeCount}"]`)&&handleOptionClick(spokeCountGroup,spokeCountInput,currentProduct.spokeCount)}if(currentProduct.wheelSize){document.querySelector(`[data-value="${currentProduct.wheelSize}"]`)&&handleOptionClick(wheelSizeGroup,wheelSizeInput,currentProduct.wheelSize)}quantityInput.value=currentProduct.quantity}}catch(e){console.error("Error loading cart from storage:",e)}}function saveCartToStorage(){try{localStorage.setItem(STORAGE_KEYS.CART,JSON.stringify(selectedProducts))}catch(e){console.error("Error saving cart to storage:",e)}}function saveCurrentProductToStorage(){try{localStorage.setItem(STORAGE_KEYS.CURRENT_PRODUCT,JSON.stringify(currentProduct))}catch(e){console.error("Error saving current product to storage:",e)}}function loadContactInfoFromStorage(){try{const e=localStorage.getItem(STORAGE_KEYS.CONTACT_INFO);if(e){const t=JSON.parse(e);document.getElementById("name").value=t.name||"",document.getElementById("email").value=t.email||"",document.getElementById("address_1").value=t.address_1||t.address||"",document.getElementById("city").value=t.city||"",document.getElementById("provinceCode").value=t.provinceCode||"",document.getElementById("postalCode").value=t.postalCode||"",document.getElementById("country").value=t.country||"",document.getElementById("notes").value=t.notes||""}}catch(e){console.error("Error loading contact info from storage:",e)}}function saveContactInfoToStorage(){try{const e={name:document.getElementById("name").value,email:document.getElementById("email").value,address_1:document.getElementById("address_1").value,city:document.getElementById("city").value,provinceCode:document.getElementById("provinceCode").value,postalCode:document.getElementById("postalCode").value,country:document.getElementById("country").value,notes:document.getElementById("notes").value};localStorage.setItem(STORAGE_KEYS.CONTACT_INFO,JSON.stringify(e))}catch(e){console.error("Error saving contact info to storage:",e)}}function clearOrderFromStorage(){try{localStorage.removeItem(STORAGE_KEYS.CART),localStorage.removeItem(STORAGE_KEYS.CONTACT_INFO)}catch(e){console.error("Error clearing order from storage:",e)}}function showErrorModal(){document.getElementById("error-modal").style.display="flex"}function showShippingErrorModal(){document.getElementById("shipping-error-modal").style.display="flex";const e=document.querySelector("#order-review .submit-btn");e.disabled=!0,e.style.opacity="0.5",e.style.cursor="not-allowed"}window.closeErrorModal=function(){document.getElementById("error-modal").style.display="none";const e=document.querySelector("#order-review .submit-btn");e.textContent=i18n.t("review.submit"),e.disabled=!1,e.style.opacity="",e.style.cursor="",e.style.transform="",e.style.boxShadow="",e.classList.remove("disabled"),console.log("Button reset:",{text:e.textContent,disabled:e.disabled,opacity:e.style.opacity})},window.closeShippingErrorModal=function(){document.getElementById("shipping-error-modal").style.display="none",shippingCalculationFailed=!1;const e=document.getElementById("contact-form"),t=document.getElementById("order-review");e.style.display="block",t.style.display="none",e.scrollIntoView({behavior:"smooth",block:"start"})};const PRICING={basePrice:45,pairDiscount:.05,taxRate:.15};let scene,camera,renderer,controls,model,shippingCalculationFailed=!1,currentShipmentId=null,currentOrderId=null;function formatWheelSize(e){return"26"===e?'26"':e}function getSpokeText(){return"fr"===(localStorage.getItem("language")||navigator.language.split("-")[0])?"rayons":"spokes"}function getValidationMessages(){return"fr"===(localStorage.getItem("language")||navigator.language.split("-")[0])?{nameRequired:"Entre ton nom",emailRequired:"Entre ton email",emailInvalid:"Entre une adresse email valide",addressRequired:"Entre ton adresse",cityRequired:"Entre ta ville",provinceRequired:"Entre ton code de province/état",postalCodeRequired:"Entre ton code postal",countryRequired:"Sélectionne ton pays"}:{nameRequired:"Please enter your name",emailRequired:"Please enter your email",emailInvalid:"Please enter a valid email address",addressRequired:"Please enter your address",cityRequired:"Please enter your city",provinceRequired:"Please enter your province/state code",postalCodeRequired:"Please enter your postal code",countryRequired:"Please select your country"}}function calculateProductPrice(e){return PRICING.basePrice*e.quantity}function calculateCartSubtotal(e){return e.reduce((e,t)=>e+calculateProductPrice(t),0)}function calculateTotalPrice(e,t=0){const o=e.reduce((e,t)=>e+calculateProductPrice(t),0),n=e.reduce((e,t)=>e+t.quantity,0),r=Math.floor(n/2),a=2*r,i=a*PRICING.basePrice*(1-PRICING.pairDiscount)+(n-a)*PRICING.basePrice,c=i*PRICING.taxRate;return{subtotal:i,taxes:c,shippingFee:t,total:i+c+t,baseSubtotal:o,discountAmount:o-i,pairsCount:r}}async function calculateShippingFee(){const e={name:document.getElementById("name").value,address_1:document.getElementById("address_1").value,city:document.getElementById("city").value,province_code:document.getElementById("provinceCode").value,postal_code:document.getElementById("postalCode").value,country_code:document.getElementById("country").value};if(!(e.name&&e.address_1&&e.city&&e.country_code))return updateShippingDisplay(0,i18n.t("contactForm.shippingValidationError")),shippingCalculationFailed=!0,void showShippingErrorModal();const t=selectedProducts.reduce((e,t)=>e+t.quantity,0),o=calculateTotalPrice(selectedProducts);try{const n=await fetch(`${API_CONFIG.baseUrl}/generate-order-id`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),r=await n.json();if(!r.success)throw new Error("Failed to generate order ID");const a=r.orderId;currentOrderId=a;const i=await fetch(`${API_CONFIG.baseUrl}/shipping`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:e,numberOfCovers:t,totalPrice:o,orderId:a})}),c=await i.json();if(c.success){if(null===c.shippingCost||void 0===c.shippingCost||0===c.shippingCost)return console.error("Shipping calculation returned invalid cost:",c.shippingCost),updateShippingDisplay(0,i18n.t("contactForm.shippingError")),shippingCalculationFailed=!0,void showShippingErrorModal();updateShippingDisplay(c.shippingCost,null),updateTotalWithShipping(c.shippingCost),currentShipmentId=c.shipmentId,shippingCalculationFailed=!1;const e=document.querySelector("#order-review .submit-btn");e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer")}else updateShippingDisplay(0,c.error||i18n.t("contactForm.shippingError")),shippingCalculationFailed=!0,showShippingErrorModal()}catch(e){console.error("Shipping calculation error:",e),updateShippingDisplay(0,i18n.t("contactForm.shippingError")),shippingCalculationFailed=!0,showShippingErrorModal()}}function updateShippingDisplay(e,t){const o=document.getElementById("shipping-fee-price");o&&(o.innerHTML=t?`<span class="shipping-error">${t}</span>`:`CAD$${e.toFixed(2)}`)}function updateTotalWithShipping(e){const t=calculateTotalPrice(selectedProducts,e);reviewTotalPrice.textContent=t.total.toFixed(2)}function updateCartDisplay(){if(0===selectedProducts.length)return void(cartSummary.style.display="none");cartSummary.style.display="block",cartItems.innerHTML="",selectedProducts.forEach((e,t)=>{const o=document.createElement("div");o.className="cart-item";const n=e.quantity>1?'<span class="discount-badge">5% OFF</span>':"";o.innerHTML=`\n            <div class="cart-item-info">\n                <div class="cart-item-quantity">${e.quantity}x</div>\n                <div class="cart-item-details">${e.spokeCount} ${getSpokeText()}, ${formatWheelSize(e.wheelSize)}</div>\n            </div>\n            <div class="cart-item-price">CAD$${calculateProductPrice(e).toFixed(2)}</div>\n            <button type="button" class="remove-item-btn" onclick="removeFromCart(${t})">×</button>\n            ${n}\n        `,cartItems.appendChild(o)});const e=calculateCartSubtotal(selectedProducts);totalPriceSpan.textContent=e.toFixed(2)}function addToCart(){if(!currentProduct.spokeCount||!currentProduct.wheelSize)return void alert(i18n.t("cart.selectBothOptions"));const e=selectedProducts.findIndex(e=>e.spokeCount===currentProduct.spokeCount&&e.wheelSize===currentProduct.wheelSize);-1!==e?selectedProducts[e].quantity+=currentProduct.quantity:selectedProducts.push({spokeCount:currentProduct.spokeCount,wheelSize:currentProduct.wheelSize,quantity:currentProduct.quantity}),currentProduct={spokeCount:"",wheelSize:"",quantity:1},localStorage.removeItem(STORAGE_KEYS.CURRENT_PRODUCT),resetProductForm(),updateCartDisplay(),saveCartToStorage();cartSummary.querySelector("h3").scrollIntoView({behavior:"smooth",block:"center"})}function resetProductForm(){document.querySelectorAll(".option-btn").forEach(e=>e.classList.remove("selected")),spokeCountInput.value="",wheelSizeInput.value="",quantityInput.value=1,currentProduct.quantity=1,addToCartBtn.disabled=!0}function initThreeJS(){scene=new THREE.Scene,scene.background=null;const e=document.getElementById("model-container");function t(){speedMultiplier+=2,speedMultiplier>maxSpeedMultiplier&&(speedMultiplier=maxSpeedMultiplier)}camera=new THREE.PerspectiveCamera(50,1,.1,1e3),camera.position.set(0,0,8),camera.lookAt(0,0,0),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setSize(e.clientWidth,e.clientWidth),e.appendChild(renderer.domElement),renderer.domElement.addEventListener("click",t),renderer.domElement.addEventListener("touchstart",e=>{e.preventDefault(),t()}),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableDamping=!0,controls.dampingFactor=.05,controls.screenSpacePanning=!1,controls.enableZoom=!1,controls.enableDolly=!1,controls.enablePan=!1,controls.minPolarAngle=Math.PI/4,controls.maxPolarAngle=3*Math.PI/4,controls.touches={ONE:THREE.TOUCH.ROTATE,TWO:THREE.TOUCH.ROTATE};(new THREE.GLTFLoader).load("/assets/models/Wheelcover_Outline.glb",function(e){model=e.scene,model.rotation.x=-Math.PI/2,model.scale.set(.27,.27,.27);const t=new THREE.MeshBasicMaterial({color:0}),o=new THREE.MeshBasicMaterial({color:15714898});model.traverse(e=>{if(e.isMesh){const n=e.material.color,r=n.r+n.g+n.b;e.material=r<.1?t:o}});const n=(new THREE.Box3).setFromObject(model).getCenter(new THREE.Vector3);model.position.sub(n),scene.add(model),animate()},void 0,function(e){console.error("Error loading model:",e)}),window.addEventListener("resize",onWindowResize,!1)}function onWindowResize(){const e=document.getElementById("model-container").clientWidth;camera.aspect=1,camera.updateProjectionMatrix(),renderer.setSize(e,e)}window.removeFromCart=function(e){selectedProducts.splice(e,1),updateCartDisplay(),saveCartToStorage()};let baseRotationSpeed=.005,speedMultiplier=1,maxSpeedMultiplier=25;function animate(){requestAnimationFrame(animate),controls.update(),model&&(model.rotation.y+=baseRotationSpeed*speedMultiplier,speedMultiplier>1&&(speedMultiplier-=.05,speedMultiplier<1&&(speedMultiplier=1))),renderer.render(scene,camera)}function initPromoScene(){const e=document.getElementById("promo-model-container");if(!e)return;const t=new THREE.Scene;t.background=null;const o=new THREE.PerspectiveCamera(50,e.clientWidth/e.clientHeight,.1,1e3);o.position.set(0,0,10),o.lookAt(0,0,0);const n=new THREE.WebGLRenderer({antialias:!0,alpha:!0});n.setSize(e.clientWidth,e.clientHeight),e.appendChild(n.domElement);const r=new THREE.AmbientLight(16777215,.5);t.add(r);const a=new THREE.DirectionalLight(16777215,.8);a.position.set(1,1,2),t.add(a);const i=[16711680,65280,255,16711935,16776960,65535,16746496,16711816,8913151,65416].map(e=>new THREE.Color(e));let c,d,l,s;(new THREE.GLTFLoader).load("/assets/models/Wheelcover_Outline.glb",function(e){c=e.scene.clone(),c.scale.set(.3,.3,.3),c.position.set(-4,0,0),c.rotation.x=-Math.PI/2;const o=new THREE.MeshPhongMaterial({color:0,shininess:100});l=new THREE.MeshPhongMaterial({color:i[0],shininess:100,transparent:!0,opacity:.8}),c.traverse(e=>{if(e.isMesh){const t=e.material.color,n=t.r+t.g+t.b;e.material=n<.1?o:l}}),t.add(c),d=e.scene.clone(),d.scale.set(.3,.3,.3),d.position.set(4,0,0),d.rotation.x=-Math.PI/2;const n=new THREE.MeshPhongMaterial({color:0,shininess:100});s=new THREE.MeshPhongMaterial({color:i[1],shininess:100,transparent:!0,opacity:.8}),d.traverse(e=>{if(e.isMesh){const t=e.material.color,o=t.r+t.g+t.b;e.material=o<.1?n:s}}),t.add(d),C()});const u={model1:{x:.04*(Math.random()-.5),y:.04*(Math.random()-.5),z:.04*(Math.random()-.5)},model2:{x:.04*(Math.random()-.5),y:.04*(Math.random()-.5),z:.04*(Math.random()-.5)}};let m=0,p=1,y=0;const g=2e3;let v=0,E=i[0].clone(),h=i[1].clone(),I=i[0].clone(),S=i[1].clone();function C(){if(requestAnimationFrame(C),c&&d&&l&&s){c.rotation.x+=u.model1.x,c.rotation.y+=u.model1.y,c.rotation.z+=u.model1.z,d.rotation.x+=u.model2.x,d.rotation.y+=u.model2.y,d.rotation.z+=u.model2.z;const e=Date.now();if(e-y>g&&(m=(m+Math.floor(3*Math.random())+1)%i.length,p=(p+Math.floor(3*Math.random())+1)%i.length,E.copy(l.color),h.copy(s.color),I.copy(i[m]),S.copy(i[p]),v=0,y=e),v<1){v+=.02;const e=new THREE.Color,t=new THREE.Color;e.lerpColors(E,I,v),t.lerpColors(h,S,v),l.color.copy(e),s.color.copy(t)}}n.render(t,o)}window.addEventListener("resize",function(){o.aspect=e.clientWidth/e.clientHeight,o.updateProjectionMatrix(),n.setSize(e.clientWidth,e.clientHeight)},!1)}function handleOptionClick(e,t,o){e.querySelectorAll(".option-btn").forEach(e=>{e.classList.remove("selected")}),event.target.classList.add("selected"),t.value=o,e===spokeCountGroup?currentProduct.spokeCount=o:currentProduct.wheelSize=o,saveCurrentProductToStorage(),addToCartBtn.disabled=!(currentProduct.spokeCount&&currentProduct.wheelSize)}function generateOrderCode(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let t="";for(let o=0;o<8;o++)t+=e.charAt(Math.floor(36*Math.random()));return t}async function createOrderInAPI(e){try{const t=await fetch(`${API_CONFIG.baseUrl}/orders`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json();throw new Error(e.error||`Request failed: ${t.status}`)}const o=await t.json();return{success:!0,orderId:o.order.id,orderCode:o.order.orderCode,totalPrice:o.order.totalPrice,taxAmount:o.order.taxAmount}}catch(e){return console.error("API Error:",e),{success:!1,error:e.message}}}function validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function validateName(e){return e.trim().length>0}function validateAddress(e){return e.trim().length>0}function showFieldError(e,t){const o=document.getElementById(e),n=o.closest(".form-group"),r=n.querySelector(".field-error");r&&r.remove(),o.classList.add("error");const a=document.createElement("div");a.className="field-error",a.textContent=t,n.appendChild(a)}function clearFieldError(e){const t=document.getElementById(e),o=t.closest(".form-group");t.classList.remove("error");const n=o.querySelector(".field-error");n&&n.remove()}function validateForm(){let e=!0;const t=getValidationMessages();validateName(document.getElementById("name").value)?clearFieldError("name"):(showFieldError("name",t.nameRequired),e=!1);const o=document.getElementById("email").value;o.trim()?validateEmail(o)?clearFieldError("email"):(showFieldError("email",t.emailInvalid),e=!1):(showFieldError("email",t.emailRequired),e=!1);const n=document.getElementById("address_1").value,r=document.getElementById("city").value,a=document.getElementById("country").value;n.trim()?clearFieldError("address_1"):(showFieldError("address_1",t.addressRequired),e=!1),r.trim()?clearFieldError("city"):(showFieldError("city",t.cityRequired),e=!1);document.getElementById("provinceCode").value.trim()?clearFieldError("provinceCode"):(showFieldError("provinceCode",t.provinceRequired),e=!1);return document.getElementById("postalCode").value.trim()?clearFieldError("postalCode"):(showFieldError("postalCode",t.postalCodeRequired),e=!1),a.trim()?clearFieldError("country"):(showFieldError("country",t.countryRequired),e=!1),e}initThreeJS(),document.addEventListener("DOMContentLoaded",()=>{initPromoScene()}),spokeCountGroup.querySelectorAll(".option-btn").forEach(e=>{e.addEventListener("click",e=>{handleOptionClick(spokeCountGroup,spokeCountInput,e.target.dataset.value)})}),wheelSizeGroup.querySelectorAll(".option-btn").forEach(e=>{e.addEventListener("click",e=>{handleOptionClick(wheelSizeGroup,wheelSizeInput,e.target.dataset.value)})}),quantityMinusBtn.addEventListener("click",()=>{currentProduct.quantity>1&&(currentProduct.quantity--,quantityInput.value=currentProduct.quantity,saveCurrentProductToStorage())}),quantityPlusBtn.addEventListener("click",()=>{currentProduct.quantity<10&&(currentProduct.quantity++,quantityInput.value=currentProduct.quantity,saveCurrentProductToStorage())}),addToCartBtn.addEventListener("click",addToCart),document.getElementById("cart-total-btn").addEventListener("click",()=>{if(0===selectedProducts.length)return void alert(i18n.t("cart.addAtLeastOneItem"));productSection.style.display="none",contactSection.style.display="block",wakeUpServer();contactSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"})}),customerForm.addEventListener("submit",e=>{if(e.preventDefault(),!validateForm())return;contactSection.style.display="none",reviewSection.style.display="block",updateReviewDisplay();reviewSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"})});let currentImageIndex=0,carouselImages=[];function initImageCarousel(){carouselImages=Array.from(document.querySelectorAll(".gallery-image")).map(e=>({src:e.src,alt:e.alt})),document.querySelectorAll(".gallery-image").forEach((e,t)=>{e.addEventListener("click",()=>openImageCarousel(t))})}function openImageCarousel(e){currentImageIndex=e;const t=document.getElementById("image-carousel"),o=document.getElementById("carousel-image");o.src=carouselImages[currentImageIndex].src,o.alt=carouselImages[currentImageIndex].alt,t.style.display="flex",document.body.style.overflow="hidden"}function updateCarouselImage(){const e=document.getElementById("carousel-image");e.src=carouselImages[currentImageIndex].src,e.alt=carouselImages[currentImageIndex].alt}window.closeImageCarousel=function(){document.getElementById("image-carousel").style.display="none",document.body.style.overflow="auto"},window.previousImage=function(){currentImageIndex=(currentImageIndex-1+carouselImages.length)%carouselImages.length,updateCarouselImage()},window.nextImage=function(){currentImageIndex=(currentImageIndex+1)%carouselImages.length,updateCarouselImage()};let touchStartX=0,touchEndX=0;function handleTouchStart(e){touchStartX=e.changedTouches[0].screenX}function handleTouchEnd(e){touchEndX=e.changedTouches[0].screenX,handleSwipe()}function handleSwipe(){const e=touchStartX-touchEndX;Math.abs(e)>50&&(e>0?nextImage():previousImage())}function updateReviewDisplay(){const e=document.getElementById("address_1").value,t=document.getElementById("city").value,o=document.getElementById("provinceCode").value,n=document.getElementById("postalCode").value;let r=e+", "+t;o&&(r+=", "+o),n&&(r+=", "+n),r+=", "+document.getElementById("country").value,reviewContactInfo.innerHTML=`\n        <div class="review-contact-item">\n            <span class="review-contact-label">Name:</span> ${document.getElementById("name").value}\n        </div>\n        <div class="review-contact-item">\n            <span class="review-contact-label">Email:</span> ${document.getElementById("email").value}\n        </div>\n        <div class="review-contact-item">\n            <span class="review-contact-label">Address:</span> ${r}\n        </div>\n        ${document.getElementById("notes").value?`\n        <div class="review-contact-item">\n            <span class="review-contact-label">Notes:</span> ${document.getElementById("notes").value}\n        </div>\n        `:""}\n    `,reviewOrderItems.innerHTML="",selectedProducts.forEach(e=>{const t=document.createElement("div");t.className="review-order-item",t.innerHTML=`\n            <div>\n                <strong>${e.quantity}x</strong> ${e.spokeCount} ${getSpokeText()}, ${formatWheelSize(e.wheelSize)}\n            </div>\n            <div>CAD$${calculateProductPrice(e).toFixed(2)}</div>\n        `,reviewOrderItems.appendChild(t)});const a=calculateTotalPrice(selectedProducts);if(a.pairsCount>0){const e=document.createElement("div");e.className="review-order-item",e.innerHTML=`\n            <div><em>5% Pair Discount (${a.pairsCount} pair${a.pairsCount>1?"s":""})</em></div>\n            <div>-CAD$${a.discountAmount.toFixed(2)}</div>\n        `,reviewOrderItems.appendChild(e)}const i=document.createElement("div");i.className="review-order-item",i.innerHTML=`\n        <div><strong>Subtotal</strong></div>\n        <div>CAD$${a.subtotal.toFixed(2)}</div>\n    `,reviewOrderItems.appendChild(i);const c=document.createElement("div");c.className="review-order-item",c.innerHTML=`\n        <div><strong>Taxes (15%)</strong></div>\n        <div>CAD$${a.taxes.toFixed(2)}</div>\n    `,reviewOrderItems.appendChild(c);const d=document.createElement("div");d.className="review-order-item",d.id="shipping-fee-item",d.innerHTML='\n        <div><strong>Shipping</strong></div>\n        <div id="shipping-fee-price" class="shipping-loader">\n            <span class="loader"></span>\n        </div>\n    ',reviewOrderItems.appendChild(d);const l=document.querySelector("#order-review .submit-btn");l&&(l.disabled=!0,l.style.opacity="0.5",l.style.cursor="not-allowed"),calculateShippingFee(),reviewTotalPrice.textContent=a.total.toFixed(2)}function checkCountrySelection(){const e=document.getElementById("country"),t=document.getElementById("other-country-message"),o=document.querySelector("#customer-form .submit-btn");"OTHER"===e.value?(t.style.display="block",o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed"):(t.style.display="none",o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer")}function checkSpecialNames(e){if("en"!==(localStorage.getItem("language")||navigator.language.split("-")[0]))return void hideSpecialNameMessage();const t=e.trim().toLowerCase();"tony"===t||"ezekiel"===t?showSpecialNameMessage(t):hideSpecialNameMessage()}function showSpecialNameMessage(e){hideSpecialNameMessage();const t=document.getElementById("name").closest(".form-group"),o=document.createElement("div");o.id="special-name-message",o.className="special-name-message",o.innerHTML=`\n        <span>Fuck you ${e.charAt(0).toUpperCase()+e.slice(1)}!</span>\n        <span class="arrow">→</span>\n    `,o.addEventListener("click",function(){window.open("https://www.youtube.com/watch?v=jqFdeC7_0_w","_blank")}),t.appendChild(o)}function hideSpecialNameMessage(){const e=document.getElementById("special-name-message");e&&e.remove()}function showOrderStatusModal(){const e=document.getElementById("order-status-modal");e?(e.style.display="flex",document.body.style.overflow="hidden"):console.error("Order status modal element not found")}async function loadOrderDetails(e){const t=document.getElementById("order-loading"),o=document.getElementById("order-content"),n=document.getElementById("order-error");t.style.display="block",o.style.display="none",n.style.display="none";try{const t=await fetch(`${API_CONFIG.baseUrl}/get-order/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}),o=await t.json();o.success&&o.order?displayOrderDetails(o.order):showOrderError()}catch(e){console.error("Error loading order details:",e),showOrderError()}}function displayOrderDetails(e){const t=document.getElementById("order-loading"),o=document.getElementById("order-content"),n=document.getElementById("order-error");t.style.display="none",n.style.display="none",o.style.display="block",document.getElementById("order-code").textContent=e.orderCode;const r=e.orderStatus||"pending",a=document.getElementById("order-status"),i=document.getElementById("order-status-description"),c=`orderStatus.status.${r}`,d=`orderStatus.statusDescription.${r}`;a.textContent=i18n.t(c)||r,i.textContent=i18n.t(d)||"";document.getElementById("order-contact-info").innerHTML=`\n        <div class="review-contact-item">\n            <span class="review-contact-label">${i18n.t("orderStatus.customerName")}</span> ${e.customerName}\n        </div>\n        <div class="review-contact-item">\n            <span class="review-contact-label">${i18n.t("orderStatus.customerEmail")}</span> ${e.customerEmail}\n        </div>\n        <div class="review-contact-item">\n            <span class="review-contact-label">${i18n.t("orderStatus.shippingAddress")}</span> ${e.shippingAddress}\n        </div>\n        ${e.notes&&e.notes.trim()?`\n        <div class="review-contact-item">\n            <span class="review-contact-label">${i18n.t("orderStatus.notes")}</span> ${e.notes}\n        </div>\n        `:""}\n    `;const l=document.getElementById("order-items");if(l.innerHTML="",e.products&&Array.isArray(e.products)&&e.products.length>0)e.products.forEach(e=>{const t=document.createElement("div");t.className="review-order-item",t.innerHTML=`\n                <div>\n                    <strong>${e.quantity}x</strong> ${e.spokeCount} ${getSpokeText()}, ${formatWheelSize(e.wheelSize)}\n                </div>\n                <div>CAD$${(e.price||0).toFixed(2)}</div>\n            `,l.appendChild(t)});else{const t=e.productSummary||"Order details not available",o=document.createElement("div");o.className="review-order-item";const n=t.replace(/\n/g,"<br>");o.innerHTML=`<div class="product-summary">${n}</div><div></div>`,l.appendChild(o)}const s=document.createElement("div");s.className="review-order-item",s.innerHTML=`\n        <div><strong>${i18n.t("orderStatus.subtotal")}</strong></div>\n        <div>CAD$${(e.subtotal||0).toFixed(2)}</div>\n    `,l.appendChild(s);const u=document.createElement("div");u.className="review-order-item",u.innerHTML=`\n        <div><strong>${i18n.t("orderStatus.taxes")}</strong></div>\n        <div>CAD$${(e.taxes||0).toFixed(2)}</div>\n    `,l.appendChild(u);const m=document.createElement("div");m.className="review-order-item",m.innerHTML=`\n        <div><strong>${i18n.t("orderStatus.shipping")}</strong></div>\n        <div>CAD$${(e.shippingFee||0).toFixed(2)}</div>\n    `,l.appendChild(m),document.getElementById("order-total").textContent=(e.totalPrice||0).toFixed(2)}function showOrderError(){const e=document.getElementById("order-loading"),t=document.getElementById("order-content"),o=document.getElementById("order-error");e.style.display="none",t.style.display="none",o.style.display="block"}document.addEventListener("DOMContentLoaded",()=>{initImageCarousel();const e=document.getElementById("image-carousel");e.addEventListener("touchstart",handleTouchStart,{passive:!0}),e.addEventListener("touchend",handleTouchEnd,{passive:!0}),document.addEventListener("keydown",e=>{"flex"===document.getElementById("image-carousel").style.display&&("ArrowLeft"===e.key?previousImage():"ArrowRight"===e.key?nextImage():"Escape"===e.key&&closeImageCarousel())})}),document.querySelector("#order-review .submit-btn").addEventListener("click",async()=>{if(shippingCalculationFailed)return void showShippingErrorModal();const e=document.getElementById("shipping-fee-price");let t=0;if(e&&!e.querySelector(".loader")){const o=e.textContent.match(/CAD\$(\d+\.?\d*)/);o&&(t=parseFloat(o[1]))}const o={products:selectedProducts,customerName:document.getElementById("name").value,customerEmail:document.getElementById("email").value,shippingAddress:{name:document.getElementById("name").value,address_1:document.getElementById("address_1").value,city:document.getElementById("city").value,province_code:document.getElementById("provinceCode").value,postal_code:document.getElementById("postalCode").value,country_code:document.getElementById("country").value},notes:document.getElementById("notes").value,language:localStorage.getItem("language")||navigator.language.split("-")[0],shippingFee:t,shipmentId:currentShipmentId,orderId:currentOrderId};try{const e=document.querySelector("#order-review .submit-btn");e.textContent;e.textContent=i18n.t("review.submitting"),e.disabled=!0,e.style.opacity="0.6";const t=await createOrderInAPI(o);if(!t.success)throw new Error(t.error);clearOrderFromStorage(),reviewSection.style.display="none",confirmationSection.style.display="block",orderCodeSpan.textContent=t.orderCode;confirmationSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"})}catch(e){console.error("Error submitting order:",e),showErrorModal();const t=document.querySelector("#order-review .submit-btn");t.textContent=i18n.t("errorModal.tryAgain"),t.disabled=!1,t.style.opacity="1"}}),document.querySelector("#contact-form .back-btn").addEventListener("click",()=>{contactSection.style.display="none",productSection.style.display="block";productSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"})}),document.querySelector("#order-review .back-btn").addEventListener("click",()=>{reviewSection.style.display="none",contactSection.style.display="block";contactSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"})}),document.getElementById("name").addEventListener("input",function(){saveContactInfoToStorage(),checkSpecialNames(this.value)}),document.getElementById("email").addEventListener("input",saveContactInfoToStorage),document.getElementById("address_1").addEventListener("input",saveContactInfoToStorage),document.getElementById("city").addEventListener("input",saveContactInfoToStorage),document.getElementById("provinceCode").addEventListener("input",saveContactInfoToStorage),document.getElementById("postalCode").addEventListener("input",saveContactInfoToStorage),document.getElementById("country").addEventListener("input",saveContactInfoToStorage),document.getElementById("country").addEventListener("change",function(){const e=document.getElementById("other-country-message"),t=document.querySelector("#customer-form .submit-btn");"OTHER"===this.value?(e.style.display="block",t.disabled=!0,t.style.opacity="0.5",t.style.cursor="not-allowed"):(e.style.display="none",t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer")}),document.getElementById("notes").addEventListener("input",saveContactInfoToStorage),window.showConfirmationDebug=function(){const e=generateOrderCode();reviewSection.style.display="none",confirmationSection.style.display="block",orderCodeSpan.textContent=e;confirmationSection.querySelector(".section-header").scrollIntoView({behavior:"smooth",block:"center"}),console.log("DEBUG: Showing confirmation page with mock order code:",e)},document.addEventListener("DOMContentLoaded",()=>{loadCartFromStorage(),loadContactInfoFromStorage(),setTimeout(checkCountrySelection,100),window.addEventListener("languageChanged",()=>{updateCartDisplay(),"block"===reviewSection.style.display&&updateReviewDisplay()})}),window.closeOrderStatusModal=function(){document.getElementById("order-status-modal").style.display="none",document.body.style.overflow="auto";const e=new URL(window.location);e.searchParams.delete("order"),window.history.replaceState({},"",e)},document.addEventListener("DOMContentLoaded",function(){const e=new URLSearchParams(window.location.search).get("order");e&&setTimeout(()=>{showOrderStatusModal(),loadOrderDetails(e)},100)});