class ToasterGame{constructor(){this.canvas=null,this.ctx=null,this.gameRunning=!1,this.gameStartTime=0,this.score=0,this.lives=5,this.maxLives=5,this.toaster=null,this.toasts=[],this.rainBalls=[],this.particles=[],this.mousePos={x:0,y:0},this.isShooting=!1,this.shootDirection={x:0,y:0},this.toasterSpeed=2,this.toastSpeed=8,this.rainSpeed=3,this.baseRainSpawnRate=.02,this.rainSpawnRate=.02,this.toastSpawnRate=.3,this.difficultyIncreaseRate=.001,this.lastShotTime=0,this.minShotInterval=200,this.hasShotThisClick=!1,this.rainColors=[{color:"#ff6600",label:"HOT",hitsRequired:1},{color:"#ff1493",label:"COOL",hitsRequired:2},{color:"#ffff00",label:"COLD",hitsRequired:3}],this.toasterImage=null,this.toastImage=null,this.rafId=null,this.countdownIntervalId=null,this.countdownTimeoutId=null,this.isMuted="true"===localStorage.getItem("toaste_game_muted"),this.init()}init(){this.canvas=document.getElementById("game-canvas"),this.ctx=this.canvas.getContext("2d"),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),window.innerWidth<=768&&this.forceMobileViewport(),this.loadAssets(),this.setupEventListeners(),this.setupGameUI()}resizeCanvas(){const t=document.getElementById("game-container");if(window.innerWidth<=768){const t=window.innerWidth,s=window.innerHeight;this.canvas.width=t,this.canvas.height=s,this.canvas.style.width=t+"px",this.canvas.style.height=s+"px",console.log("Mobile canvas resize:",{width:t,height:s,canvasWidth:this.canvas.width,canvasHeight:this.canvas.height})}else this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight;this.toaster&&(this.toaster.x=this.canvas.width/2,this.toaster.y=this.canvas.height-70)}forceMobileViewport(){const t=document.getElementById("game-container"),s=document.getElementById("game-overlay"),e=window.innerWidth,i=window.innerHeight;t.style.width=e+"px",t.style.height=i+"px",s.style.width=e+"px",s.style.height=i+"px",this.canvas.width=e,this.canvas.height=i,this.canvas.style.width=e+"px",this.canvas.style.height=i+"px",console.log("VIEWPORT FIX:",{width:e,height:i})}loadAssets(){this.toasterImage=new Image,this.toasterImage.onload=()=>{this.toasterImage.width=80,this.toasterImage.height=50},this.toasterImage.src="assets/graphics/toaster.svg",this.toastImage=new Image,this.toastImage.onload=()=>{this.toastImage.width=24,this.toastImage.height=24},this.toastImage.src="assets/graphics/toast.svg"}setupEventListeners(){this.canvas.addEventListener("mousemove",t=>{const s=this.canvas.getBoundingClientRect();this.mousePos.x=t.clientX-s.left,this.mousePos.y=t.clientY-s.top}),this.canvas.addEventListener("mousedown",t=>{this.gameRunning&&(this.isShooting=!0,this.hasShotThisClick=!1,this.calculateShootDirection())}),this.canvas.addEventListener("mouseup",()=>{this.isShooting=!1}),this.canvas.addEventListener("touchstart",t=>{if(t.preventDefault(),this.gameRunning){const s=t.touches[0],e=this.canvas.getBoundingClientRect();this.mousePos.x=s.clientX-e.left,this.mousePos.y=s.clientY-e.top,this.isShooting=!0,this.hasShotThisClick=!1,this.calculateShootDirection()}}),this.canvas.addEventListener("touchmove",t=>{if(t.preventDefault(),this.gameRunning){const s=t.touches[0],e=this.canvas.getBoundingClientRect();this.mousePos.x=s.clientX-e.left,this.mousePos.y=s.clientY-e.top}}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.isShooting=!1}),document.getElementById("restart-game").addEventListener("click",()=>{this.restartGame()}),document.getElementById("exit-game").addEventListener("click",()=>{this.exitGame()});const t=document.getElementById("sound-toggle");t&&(this.updateSoundToggleUI(),t.addEventListener("click",()=>{if(this.isMuted=!this.isMuted,localStorage.setItem("toaste_game_muted",String(this.isMuted)),this.updateSoundToggleUI(),this.isMuted&&this.readyAudio)try{this.readyAudio.pause()}catch{}}))}updateSoundToggleUI(){const t=document.getElementById("sound-toggle");t&&(this.isMuted?(t.classList.add("muted"),t.setAttribute("aria-label","Sound off"),t.title="Sound off"):(t.classList.remove("muted"),t.setAttribute("aria-label","Sound on"),t.title="Sound on"))}setupGameUI(){this.updateUI()}calculateShootDirection(){if(this.toaster){const t=this.mousePos.x-this.toaster.x,s=this.mousePos.y-this.toaster.y,e=Math.sqrt(t*t+s*s);this.shootDirection.x=t/e,this.shootDirection.y=s/e}}startGame(){this.showCountdown()}showCountdown(){const t=document.getElementById("countdown-screen"),s=document.getElementById("countdown-number");this.clearTimers(),t.style.display="flex",s.textContent="3",this.playReadySound();let e=3;const i=setInterval(()=>{e--,e>0?s.textContent=e:(clearInterval(i),this.countdownIntervalId=null,s.textContent="POLO!",this.countdownTimeoutId=setTimeout(()=>{t.style.display="none",this.startGameplay(),this.countdownTimeoutId=null},800))},1e3);this.countdownIntervalId=i}startGameplay(){window.innerWidth<=768&&this.forceMobileViewport(),this.gameRunning=!0,this.gameStartTime=Date.now(),this.score=0,this.lives=this.maxLives,this.rainSpawnRate=this.baseRainSpawnRate,this.rainStartTime=Date.now()+2e3,this.toaster={x:this.canvas.width/2,y:this.canvas.height-70,width:80,height:50,direction:1,speed:this.toasterSpeed,bumpScale:1,bumpDuration:0,maxBumpDuration:10,opacity:0,isDead:!1,deathBounce:0,deathVelocity:{x:0,y:-8},deathRotation:0,deathRotationSpeed:.1},this.toasts=[],this.rainBalls=[],this.particles=[],this.screenFlash={active:!1,duration:0,maxDuration:120,flashCount:0,maxFlashes:1,isGameOver:!1,flashDelay:0,maxFlashDelay:150};document.getElementById("game-ui").classList.add("fade-in"),this.updateUI(),this.gameLoop()}gameLoop(){this.gameRunning||this.screenFlash.active||this.toaster&&this.toaster.isDead?(this.update(),this.render(),this.rafId=requestAnimationFrame(()=>this.gameLoop())):this.rafId=null}update(){if(this.updateScreenFlash(),this.updateToaster(),this.gameRunning){const t=Date.now();this.score=Math.floor((t-this.gameStartTime)/1e3),this.rainSpawnRate=this.baseRainSpawnRate+this.score*this.difficultyIncreaseRate,this.updateToasts(),this.updateRainBalls(),this.updateParticles(),this.checkCollisions(),this.spawnRainBalls(),this.isShooting&&this.spawnToasts(),this.updateUI()}}updateToaster(){if(!this.toaster)return;if(this.toaster.isDead)return this.toaster.deathVelocity.y+=.3,this.toaster.x+=this.toaster.deathVelocity.x,this.toaster.y+=this.toaster.deathVelocity.y,this.toaster.deathRotation+=this.toaster.deathRotationSpeed,this.toaster.y>=this.canvas.height-this.toaster.height&&this.toaster.deathBounce<=2&&(this.toaster.y=this.canvas.height-this.toaster.height,this.toaster.deathVelocity.y*=-.6,this.toaster.deathBounce++,this.toaster.deathVelocity.x+=2*(Math.random()-.5)),this.toaster.deathBounce>2&&(this.toaster.deathVelocity.y=Math.abs(this.toaster.deathVelocity.y),this.toaster.deathVelocity.x=0),void(this.toaster.y>this.canvas.height+100&&(this.toaster.opacity=Math.max(0,this.toaster.opacity-.02)));const t=Date.now(),s=this.gameStartTime;if(t-s<1e3){const e=(t-s)/1e3;this.toaster.opacity=Math.min(1,e)}else this.toaster.opacity=1;if(this.toaster.bumpDuration>0){this.toaster.bumpDuration--;const t=1-this.toaster.bumpDuration/this.toaster.maxBumpDuration;this.toaster.bumpScale=1+.05*Math.sin(t*Math.PI)}else this.toaster.bumpScale=1;this.toaster.x+=this.toaster.direction*this.toaster.speed,(this.toaster.x<=0||this.toaster.x>=this.canvas.width-this.toaster.width)&&(this.toaster.direction*=-1,this.toaster.x=Math.max(0,Math.min(this.canvas.width-this.toaster.width,this.toaster.x))),Math.random()<.005&&(this.toaster.direction*=-1)}updateToasts(){for(let t=this.toasts.length-1;t>=0;t--){const s=this.toasts[t];s.x+=s.vx,s.y+=s.vy,s.rotation+=s.rotationSpeed,(s.x<0||s.x>this.canvas.width||s.y<0||s.y>this.canvas.height)&&this.toasts.splice(t,1)}}updateRainBalls(){for(let t=this.rainBalls.length-1;t>=0;t--){const s=this.rainBalls[t];s.y+=s.speed,s.rotation+=s.rotationSpeed,s.y>this.canvas.height&&this.rainBalls.splice(t,1)}}updateParticles(){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t];s.x+=s.vx,s.y+=s.vy,s.life--,s.life<=0&&this.particles.splice(t,1)}}updateScreenFlash(){if(this.screenFlash.active){if(this.screenFlash.flashDelay>0)return this.screenFlash.flashDelay+=16,void(this.screenFlash.flashDelay>=this.screenFlash.maxFlashDelay&&(this.screenFlash.flashDelay=0,this.screenFlash.duration=0));this.screenFlash.duration+=16,this.screenFlash.duration>=this.screenFlash.maxDuration&&(this.screenFlash.flashCount++,this.screenFlash.flashCount>=this.screenFlash.maxFlashes?(this.screenFlash.active=!1,this.screenFlash.duration=0,this.screenFlash.flashCount=0,this.screenFlash.flashDelay=0,this.screenFlash.isGameOver&&(this.screenFlash.isGameOver=!1,this.showGameOverScreen())):this.screenFlash.flashDelay=16)}}spawnToasts(){if(this.isShooting&&this.toaster&&!this.hasShotThisClick){const t=Date.now();t-this.lastShotTime>=this.minShotInterval&&(this.toaster.bumpDuration=this.toaster.maxBumpDuration,this.playRandomHitSound(),this.toasts.push({x:this.toaster.x+this.toaster.width/2-12,y:this.toaster.y-18,width:24,height:24,vx:this.shootDirection.x*this.toastSpeed,vy:this.shootDirection.y*this.toastSpeed,rotation:0,rotationSpeed:.3*(Math.random()-.5)+.1}),this.lastShotTime=t,this.hasShotThisClick=!0)}}spawnRainBalls(){if(!(Date.now()<this.rainStartTime)&&Math.random()<this.rainSpawnRate){const t=this.rainColors[Math.floor(Math.random()*this.rainColors.length)];this.rainBalls.push({x:Math.random()*this.canvas.width,y:-20,radius:20,originalRadius:20,color:t.color,label:t.label,hitsRequired:t.hitsRequired,hitsTaken:0,speed:3*Math.random()+this.rainSpeed,rotation:0,rotationSpeed:.2*(Math.random()-.5)})}}playRandomHitSound(){if(!this.isMuted)try{const t=Math.floor(3*Math.random())+1,s=new Audio(`/assets/sounds/hit-0${t}.mp3`);s.volume=.45,s.playbackRate=.95+.1*Math.random(),s.play().catch(()=>{})}catch{}}playRandomBangSound(){if(!this.isMuted)try{const t=Math.floor(2*Math.random())+1,s=new Audio(`/assets/sounds/bang-0${t}.mp3`);s.volume=.4,s.playbackRate=.95+.1*Math.random(),s.play().catch(()=>{})}catch{}}playRandomPunchSound(){if(!this.isMuted)try{const t=Math.floor(2*Math.random())+1,s=new Audio(`/assets/sounds/punch-0${t}.mp3`);s.volume=.35,s.playbackRate=.95+.1*Math.random(),s.play().catch(()=>{})}catch{}}playReadySound(){if(!this.isMuted)try{this.readyAudio&&(this.readyAudio.pause(),this.readyAudio=null);const t=new Audio("/assets/sounds/ready.mp3");t.volume=.25,t.currentTime=2.6,t.play().catch(()=>{}),this.readyAudio=t}catch{}}playGameOverSound(){if(!this.isMuted)try{const t=new Audio("/assets/sounds/awww.mp3");t.volume=.35,t.play().catch(()=>{})}catch{}}checkCollisions(){if(this.toaster)for(let t=this.rainBalls.length-1;t>=0;t--){const s=this.rainBalls[t];this.circleRectCollision(s,this.toaster)&&(this.lives--,this.createParticles(s.x,s.y,s.color),this.playRandomPunchSound(),this.rainBalls.splice(t,1),this.screenFlash.active=!0,this.screenFlash.duration=0,this.screenFlash.flashCount=0,this.screenFlash.flashDelay=0,this.lives<=0?(this.toaster.isDead=!0,this.toaster.deathVelocity.x=4*(Math.random()-.5),this.toaster.deathVelocity.y=-8,this.toaster.deathRotationSpeed=.2*(Math.random()-.5),this.screenFlash.maxFlashes=5,this.screenFlash.isGameOver=!0,this.gameRunning=!1):(this.screenFlash.maxFlashes=1,this.screenFlash.isGameOver=!1))}for(let t=this.toasts.length-1;t>=0;t--){const s=this.toasts[t];for(let e=this.rainBalls.length-1;e>=0;e--){const i=this.rainBalls[e];if(this.circleRectCollision(i,s)){if(i.hitsTaken++,this.createParticles(i.x,i.y,i.color),this.playRandomBangSound(),this.toasts.splice(t,1),i.hitsTaken>=i.hitsRequired)this.rainBalls.splice(e,1);else{const t=.3*i.originalRadius;i.radius=Math.max(i.originalRadius-i.hitsTaken*t,.2*i.originalRadius)}break}}}}circleRectCollision(t,s){const e=Math.max(s.x,Math.min(t.x,s.x+s.width)),i=Math.max(s.y,Math.min(t.y,s.y+s.height)),a=t.x-e,o=t.y-i;return a*a+o*o<t.radius*t.radius}createParticles(t,s,e){for(let i=0;i<8;i++)this.particles.push({x:t,y:s,vx:10*(Math.random()-.5),vy:10*(Math.random()-.5),color:e,life:30})}render(){if(this.ctx.fillStyle="#efca52",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.toaster){this.ctx.save(),this.ctx.globalAlpha=this.toaster.opacity||1,this.toaster.isDead&&(this.ctx.translate(this.toaster.x+this.toaster.width/2,this.toaster.y+this.toaster.height/2),this.ctx.rotate(this.toaster.deathRotation),this.ctx.translate(-this.toaster.width/2,-this.toaster.height/2));const t=this.toaster.width*this.toaster.bumpScale,s=this.toaster.height*this.toaster.bumpScale,e=(this.toaster.width-t)/2,i=(this.toaster.height-s)/2,a=this.toaster.isDead?e:this.toaster.x+e,o=this.toaster.isDead?i:this.toaster.y+i;this.toasterImage.complete?this.ctx.drawImage(this.toasterImage,a,o,t,s):(this.ctx.fillStyle="#2D2218",this.ctx.fillRect(a,o,t,s)),this.ctx.restore()}for(const t of this.toasts)this.ctx.save(),this.ctx.translate(t.x+t.width/2,t.y+t.height/2),this.ctx.rotate(t.rotation),this.toastImage.complete?this.ctx.drawImage(this.toastImage,-t.width/2,-t.height/2,t.width,t.height):(this.ctx.fillStyle="#D4A574",this.ctx.fillRect(-t.width/2,-t.height/2,t.width,t.height)),this.ctx.restore();for(const t of this.rainBalls)this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation),this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(0,0,t.radius,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#2D2218",this.ctx.font="bold 12px FKRasterGrotesk",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t.label,0,0),this.ctx.restore();for(const t of this.particles)this.ctx.fillStyle=t.color,this.ctx.globalAlpha=t.life/30,this.ctx.fillRect(t.x,t.y,4,4),this.ctx.globalAlpha=1;if(this.isShooting&&this.toaster&&(this.ctx.strokeStyle="#2D2218",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(this.mousePos.x-10,this.mousePos.y),this.ctx.lineTo(this.mousePos.x+10,this.mousePos.y),this.ctx.moveTo(this.mousePos.x,this.mousePos.y-10),this.ctx.lineTo(this.mousePos.x,this.mousePos.y+10),this.ctx.stroke()),this.screenFlash.active){let t=0;if(this.screenFlash.flashDelay>0)t=0;else{const s=this.screenFlash.duration/this.screenFlash.maxDuration;t=Math.sin(s*Math.PI)}this.ctx.save(),this.ctx.globalAlpha=.95*t,this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}}updateUI(){document.getElementById("score-value").textContent=this.score,this.updateLivesDisplay()}updateLivesDisplay(){document.querySelectorAll(".toast-live-icon").forEach((t,s)=>{s<this.lives?t.classList.remove("lost"):t.classList.add("lost")})}showGameOverScreen(){this.playGameOverSound(),document.getElementById("final-score").textContent=this.score,document.getElementById("game-over-screen").classList.remove("hidden")}gameOver(){}restartGame(){document.getElementById("game-over-screen").classList.add("hidden"),this.fullStop(),this.toaster&&(this.toaster.isDead=!1,this.toaster.x=this.canvas.width/2,this.toaster.y=this.canvas.height-70,this.toaster.deathBounce=0,this.toaster.deathVelocity={x:0,y:-8},this.toaster.deathRotation=0,this.toaster.deathRotationSpeed=.1,this.toaster.opacity=0),this.startGame()}exitGame(){this.fullStop(),document.getElementById("game-over-screen").classList.add("hidden"),document.getElementById("game-overlay").classList.add("hidden"),document.querySelector(".main-content").classList.remove("fade-out"),document.body.classList.remove("game-active")}clearTimers(){this.countdownIntervalId&&(clearInterval(this.countdownIntervalId),this.countdownIntervalId=null),this.countdownTimeoutId&&(clearTimeout(this.countdownTimeoutId),this.countdownTimeoutId=null)}fullStop(){this.gameRunning=!1,null!==this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.clearTimers(),this.screenFlash&&(this.screenFlash.active=!1,this.screenFlash.duration=0,this.screenFlash.flashCount=0,this.screenFlash.flashDelay=0,this.screenFlash.isGameOver=!1),this.toaster&&(this.toaster.isDead=!1),this.toasts=[],this.rainBalls=[],this.particles=[]}}class GameActivator{constructor(){this.clickCount=0,this.clickTimeout=null,this.clickWindow=1e3,this.game=null,this.logoAnimating=!1,this.init()}init(){const t=document.querySelector(".logo-container");t&&(t.addEventListener("mousedown",t=>{this.handleClick(t)}),t.addEventListener("touchstart",t=>{t.preventDefault(),this.handleClick(t)}))}handleClick(t){if(t.preventDefault(),this.clickTimeout&&clearTimeout(this.clickTimeout),0===this.clickCount&&window.toasterMovementControl&&window.toasterMovementControl.startClickWindow(),this.clickCount++,console.log(`Logo clicked! Count: ${this.clickCount}/10`),this.animateMainLogo(),this.animateToaster(),this.clickCount>=10)return console.log("🎮 Game activated! 10 consecutive clicks detected!"),void this.activateGame();this.clickTimeout=setTimeout(()=>{console.log(`⏰ Click timeout! Resetting count from ${this.clickCount} to 0`),this.clickCount=0,this.resetToaster(),window.toasterMovementControl&&window.toasterMovementControl.endClickWindow()},this.clickWindow)}animateMainLogo(){const t=document.querySelector(".logo-container");if(!t)return;if(this.logoAnimating)return void console.log("Logo animation already running, skipping...");console.log("Starting logo animation..."),this.logoAnimating=!0;t.style.transition="transform 200ms ease-in-out",t.style.transform="scale(1.05)",setTimeout(()=>{t.style.transform="scale(1.0)"},100),setTimeout(()=>{t.style.transition="",this.logoAnimating=!1,console.log("Logo animation complete")},200)}animateToaster(){const t=document.querySelector("#toaster");if(!t)return;t.style.transformOrigin="center center";const s=this.clickCount/10,e=1+.15*s,i=8*s;this.performBouncyInflation(t,e,i),console.log(`Toaster inflating to ${e.toFixed(2)}x and moving up ${i.toFixed(1)}px (${this.clickCount}/10 clicks)`)}performBouncyInflation(t,s,e){const i=s+.04,a=e+1;t.style.transition="transform 0.18s cubic-bezier(0.68, -0.25, 0.265, 1.25)",t.style.transform=`translateY(-${a}px) scale(${i})`,setTimeout(()=>{const i=s-.015,a=e-.3;t.style.transition="transform 0.12s cubic-bezier(0.25, 0.46, 0.45, 0.94)",t.style.transform=`translateY(-${a}px) scale(${i})`,setTimeout(()=>{t.style.transition="transform 0.08s cubic-bezier(0.25, 0.46, 0.45, 0.94)",t.style.transform=`translateY(-${e}px) scale(${s})`},120)},180)}resetToaster(){const t=document.querySelector("#toaster");t&&(t.style.transformOrigin="center center",t.style.transition="transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)",t.style.transform="translateY(0px) scale(1.0)",console.log("Toaster reset to original size and position"))}activateGame(){this.clickCount=0,window.toasterMovementControl&&window.toasterMovementControl.endClickWindow();document.querySelector(".main-content").classList.add("fade-out"),setTimeout(()=>{document.getElementById("game-overlay").classList.remove("hidden"),document.body.classList.add("game-active"),this.game?this.game.fullStop():this.game=new ToasterGame,this.game.startGame()},1e3)}}document.addEventListener("DOMContentLoaded",()=>{new GameActivator});